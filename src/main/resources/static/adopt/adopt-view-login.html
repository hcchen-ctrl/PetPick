<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>領養詳情</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="icon" href="/images/pet-icon.png">
    <link rel="stylesheet" href="/adopt/styles.css">
</head>

<body class="bg-light">
<div class="container py-4" id="box">載入中…</div>

<script>
    const id = new URLSearchParams(location.search).get('id');

    function apply(id) {
        fetch(`/api/adopts/${id}/apply`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
            .then(r => r.json())
            .then(_ => alert('申請已送出！'));
    }

    async function init() {
        try {
            const [authRes, postRes] = await Promise.all([
                fetch('/api/auth/status', { credentials: 'include' }),
                fetch(`/api/adopts/${id}`)
            ]);

            const auth = await authRes.json();
            const p = await postRes.json();

            const loggedIn = auth.loggedIn;
            const badge = p.sourceType === 'platform'
                ? '<span class="badge text-bg-primary ms-2">我方救助</span>'
                : '<span class="badge text-bg-warning ms-2">民眾送養</span>';

            let bottom = '';

            if (!loggedIn) {
                // 未登入使用者
                bottom = (p.sourceType === 'user')
                    ? `<div class="alert alert-warning">聯絡資訊僅登入會員可見</div>`
                    : `<div class="alert alert-info">官方刊登，<a href="/login.html">請登入</a> 以進一步申請</div>`;
            } else {
                // 已登入使用者
                if (p.sourceType === 'user') {
                    bottom = `
                            <div class="alert alert-success">
                                聯絡人：${p.contactName || '—'}　電話：${p.contactPhone || '—'}　LINE：${p.contactLine || '—'}
                            </div>`;
                } else {
                    bottom = `<button class="btn btn-primary" onclick="apply(${p.id})">我要領養</button>`;
                }
            }

            document.getElementById('box').innerHTML = `
                    <div class="row g-4">
                        <div class="col-md-6">
                            <img class="img-fluid rounded" src="${p.image1 || '/images/no-image.jpg'}"
                                onerror="this.src='/images/no-image.jpg'">
                        </div>
                        <div class="col-md-6">
                            <h3>${p.title || ''} ${badge}</h3>
                            <div class="text-muted mb-2">${p.city || ''} ${p.district || ''}</div>
                            <div>種類：${p.species || ''}　品種：${p.breed || ''}　性別：${p.sex || ''}　年齡：${p.age || ''}</div>
                            <p class="mt-3">${p.description || ''}</p>
                            ${bottom}
                        </div>
                    </div>`;
        } catch (err) {
            console.error('載入失敗', err);
            document.getElementById('box').innerHTML = `
                    <div class="alert alert-danger mt-4">無法載入資料，請稍後再試。</div>`;
        }
    }

    init();
</script>
</body>

</html>
