<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>收養回報中心</title>
  <link rel="icon" href="/images/pet-icon.png" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .side-btn {
      width: 100%;
      text-align: left;
      padding: .75rem 1rem;
      border-radius: 12px
    }

    .side-btn.active {
      outline: 2px solid #0d6efd20;
      box-shadow: 0 0 0 2px #0d6efd20 inset
    }

    .card-report {
      border-radius: 15px;
      color: #333;
      background: #fff;
      padding: 1rem;
      margin-bottom: 1.5rem;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .05)
    }

    .card-report .report-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: .75rem;
      background: #f3f3f3
    }

    .count-badge {
      font-size: 14px;
      color: #666
    }

    .section-pane {
      display: none
    }

    .section-pane.active {
      display: block
    }

    #reportForm input[type="text"][disabled],
    #reportForm input[type="date"],
    #reportForm textarea,
    #reportForm input[type="file"] {
      background-color: #fff6e5
    }

    .info-card {
      padding: .75rem;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .05);
      font-size: .9rem
    }

    .bg-success-subtle {
      background-color: #eaf7f0
    }

    .bg-danger-subtle {
      background-color: #fbeaea
    }
  </style>
</head>

<body>
  <!-- Navbar 保持原樣 -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="/index.html">
        <img src="/images/pet-icon.png" width="36" height="36" class="d-inline-block align-top" alt="logo"> PetPick
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center w-100">
          <ul class="navbar-nav mb-2 mb-lg-0">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle btn btn-login m-1" href="#" id="adoptDropdown" role="button"
                data-bs-toggle="dropdown">尋找領養</a>
              <ul class="dropdown-menu" aria-labelledby="adoptDropdown">
                <li><a class="dropdown-item" href="/gov-list.html">公立認養</a></li>
                <li><a class="dropdown-item" href="/adopt-list.html">領養認養</a></li>
                <li><a class="dropdown-item" href="/post-adopt.html">刊登送養</a></li>
                <li><a class="dropdown-item" href="/adopt-report.html">收養回報</a></li>
              </ul>
            </li>
            <li class="nav-item"><a class="nav-link btn btn-login m-1" href="/mission/missonMain.html">尋找任務</a></li>
            <li class="nav-item"><a class="nav-link btn btn-login m-1" href="/shop/index.html">寵物商城</a></li>
          </ul>
          <div class="d-lg-none mt-2 mobile-iconbar">
            <button class="btn btn-material"><span class="material-icons">chat_bubble_outline</span></button>
            <button class="btn btn-material"><span class="material-icons">shopping_cart</span></button>
            <button class="btn btn-material"><span class="material-icons">account_circle</span></button>
          </div>
          <div id="desktop-iconbar" class="d-none d-lg-block position-fixed end-0 m-4" style="z-index:1030;">
            <button class="btn btn-material"><span class="material-icons">chat_bubble_outline</span></button>
            <button class="btn btn-material"><span class="material-icons">shopping_cart</span></button>
            <button class="btn btn-material"><span class="material-icons">account_circle</span></button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- 主內容 -->
  <div class="container mt-5 pt-5">
    <div class="row g-4">
      <!-- 左側按鈕 -->
      <aside class="col-lg-3">
        <div class="sticky-top" style="top:92px;">
          <div class="d-grid gap-3">

            <!-- 我的寵物清單：只顯示此會員且仍需回報的收養 -->
            <div class="mt-3">
              <label for="myPets" class="form-label fw-bold">
                <i class="fa-solid fa-paw me-2"></i>選擇我的寵物
              </label>
              <select id="myPets" class="form-select">
                <option value="">讀取中…</option>
              </select>
            </div>

            <button id="btn-report" class="btn btn-login side-btn active" data-target="pane-report"><i
                class="fa-solid fa-file-signature me-2"></i>收養回報</button>
            <button id="btn-records" class="btn btn-outline-secondary side-btn" data-target="pane-records"><i
                class="fa-solid fa-rectangle-list me-2"></i>回報紀錄</button>
          </div>
          <div class="mt-4">
            <div class="info-card bg-success-subtle text-success mb-2"><strong>追蹤回報：</strong>認養後一年內持續追蹤，每月回報一次。</div>
            <div class="info-card bg-danger-subtle text-danger"><strong>特殊情況：</strong>若動物出現健康或行為問題，請立即回報。</div>
          </div>
        </div>
      </aside>

      <!-- 右側：收養回報 -->
      <main class="col-lg-9">
        <section id="pane-report" class="section-pane active">
          <h2 class="mb-4">收養回報</h2>
          <div class="row">
            <div class="col-md-4">
              <div id="reportPaneLeft" class="bg-white p-4 rounded shadow-sm"></div>
            </div>
            <div class="col-md-8">
              <form id="reportForm">
                <div class="mb-3">
                  <label for="adopterName" class="form-label">領養人姓名</label>
                  <input type="text" class="form-control" id="adopterName" disabled>
                </div>
                <div class="mb-3">
                  <label for="reportDate" class="form-label">回報日期</label>
                  <input type="date" class="form-control" id="reportDate">
                </div>
                <div class="mb-3">
                  <label class="form-label">適應狀況（僅顯示用）</label><br>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="status" value="SUBMITTED" checked>
                    <label class="form-check-label">良好</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="status" value="SUBMITTED">
                    <label class="form-check-label">普通</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="status" value="SUBMITTED">
                    <label class="form-check-label">尚待觀察</label>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="description" class="form-label">近況描述（最多 50 字）</label>
                  <textarea class="form-control" id="description" rows="3" maxlength="50"
                    placeholder="分享寵物生活點滴…"></textarea>
                  <div class="text-end"><small id="charCount">剩餘 50 字</small></div>
                </div>
                <div class="mb-3">
                  <label for="photo" class="form-label">照片上傳</label>
                  <input class="form-control" type="file" id="photo" accept="image/*">
                </div>
                <button type="submit" class="btn btn-login w-100 mt-2">提交</button>
              </form>
            </div>
          </div>
        </section>

        <!-- 右側：回報紀錄 -->
        <section id="pane-records" class="section-pane">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="mb-0">回報紀錄</h2>
            <span class="count-badge">共 <span id="countAll">0</span> 筆</span>
          </div>
          <div id="cardRow" class="row"></div>
        </section>
      </main>
    </div>
  </div>

  <!-- 詳細 Modal -->
  <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">回報詳情</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-5"><img id="modalImg" class="img-fluid rounded" src="" alt=""></div>
            <div class="col-md-7">
              <ul class="list-group list-group-flush">
                <li class="list-group-item"><strong>寵物名稱：</strong><span id="mPet"></span></li>
                <li class="list-group-item"><strong>回報日期：</strong><span id="mDate"></span></li>
                <li class="list-group-item"><strong>近況描述：</strong><span id="mDesc"></span></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 匯入 API（module） -->
  <script type="module">
    import { createReport, listReportsByAdoptionId } from '/js/reportapi.js';
    window.__reportapi = { createReport, listReportsByAdoptionId };
  </script>

  <!-- 頁面腳本 -->
  <script>
    const $ = s => document.querySelector(s);
    const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({ '&': '&', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    const safeImg = s => s && /^(https?:\/\/|data:image\/|\/images\/|\/uploads\/|\/feedback\/)/i.test(s) ? s : '';



    function toDataURL(file) {
      return new Promise(res => {
        if (!file) return res('');
        const fr = new FileReader(); fr.onload = () => res(fr.result); fr.readAsDataURL(file);
      });
    }

    function renderAdoptionInfo(a) {
      const box = $('#reportPaneLeft'); if (!box) return;
      box.innerHTML = `
        <div class="text-center">
          <img src="${safeImg(a.imageUrl) || '/images/noimg.png'}" alt="${esc(a.petName || '')}" class="img-fluid rounded mb-3"/>
          <h5 class="mb-1">${esc(a.petName || '')}</h5>
          <p class="mb-0 text-muted"><small>領養日期：${esc((a.adoptionDate || '').slice(0, 10)) || '—'}</small></p>
        </div>`;
      const owner = $('#adopterName'); if (owner) owner.value = a.ownerName || '';
    }

    // ===== 我的寵物（只屬於登入會員、且仍需回報） =====
    const API_MY_ADOPTIONS = '/api/petreport/my-adoptions'; // 後端以 session/userId 過濾

    const state = { adoptions: [], currentId: null };

    async function loadMyAdoptions() {
      const sel = document.getElementById('myPets');
      sel.disabled = true; sel.innerHTML = '<option value="">讀取中…</option>';

      try {
        const r = await fetch(API_MY_ADOPTIONS, { credentials: 'include' });
        const list = await r.json(); // 期望回來是陣列；若你的後端回 Page，請改用 list.content
        state.adoptions = Array.isArray(list) ? list : (list?.content ?? []);
      } catch (e) {
        console.error(e);
        state.adoptions = [];
      }

      // 無資料
      if (!state.adoptions.length) {
        sel.innerHTML = '<option value="">目前沒有需要回報的寵物</option>';
        sel.disabled = true;
        state.currentId = null;
        document.getElementById('reportPaneLeft').innerHTML =
          '<div class="text-muted small">尚無可回報的寵物</div>';
        return;
      }

      // 重建下拉
      sel.innerHTML = state.adoptions.map(a => {
        const name = a.petName ?? a.pet_name ?? `#${a.postIdExt ?? a.post_id_ext}`;
        const ad = (a.adoptionDate ?? a.adoption_date ?? '').toString().slice(0, 10);
        const img = a.imageUrl ?? a.image_url ?? '';
        return `<option value="${a.id}" data-img="${img}" data-date="${ad}" data-owner="${a.ownerName ?? ''}">
              ${name}（領養日：${ad || '—'}）
            </option>`;
      }).join('');
      sel.disabled = false;

      // 預設第一筆
      sel.value = String(state.adoptions[0].id);
      state.currentId = String(state.adoptions[0].id);

      // 左側資訊（盡量用現有欄位，沒有就呼叫你已寫的 renderAdoptionInfo）
      renderAdoptionInfo({
        petName: state.adoptions[0].petName ?? state.adoptions[0].pet_name,
        imageUrl: state.adoptions[0].imageUrl ?? state.adoptions[0].image_url,
        ownerName: state.adoptions[0].ownerName,
        adoptionDate: state.adoptions[0].adoptionDate ?? state.adoptions[0].adoption_date
      });

      await renderRecords(state.currentId);
    }

    document.getElementById('myPets').addEventListener('change', async (e) => {
      const sel = e.currentTarget;
      state.currentId = sel.value || null;
      if (!state.currentId) return;

      const opt = sel.selectedOptions[0];
      renderAdoptionInfo({
        petName: opt.textContent.split('（')[0],
        imageUrl: opt.dataset.img || '',
        ownerName: opt.dataset.owner || '',
        adoptionDate: opt.dataset.date || ''
      });

      await renderRecords(state.currentId);
    });



    function bindCardClick(el) {
      el.addEventListener('click', () => {
        $('#modalImg').src = el.querySelector('img')?.src || '';
        $('#mPet').textContent = el.dataset.pet || '';
        $('#mDate').textContent = el.dataset.date || '';
        $('#mDesc').textContent = el.dataset.desc || '';
        new bootstrap.Modal($('#detailModal')).show();
      });
    }

    function updateCount() {
      const cnt = document.querySelectorAll('#cardRow .card-col').length;
      $('#countAll').textContent = cnt || 0;
    }

    async function renderRecords(adoptionId) {
      const cont = $('#cardRow'); if (!cont) return;
      cont.innerHTML = '';
      const rows = await window.__reportapi.listReportsByAdoptionId(adoptionId);
      if (!rows.length) {
        cont.innerHTML = '<div class="text-center text-muted p-3">尚無回報紀錄</div>'; updateCount(); return;
      }
      rows.sort((b, a) => new Date(a.reportDate) - new Date(b.reportDate));
      for (const r of rows) {
        const pet = esc(r.petName || ''), desc = esc(r.notes || ''), d = esc((r.reportDate || '').slice(0, 10));
        const col = document.createElement('div'); col.className = 'col-md-6 col-lg-4 card-col';
        col.innerHTML = `
          <div class="card-report" data-pet="${pet}" data-date="${d}" data-desc="${desc}">
            <img class="report-img" src="${safeImg(r.imageUrl)}" alt="${pet} 回報照片"/>
            <h6 class="mb-1">${pet || '—'}</h6>
            <p class="mb-1"><small>日期：${d || '—'}</small></p>
            <p class="mb-0"><small>描述：${desc}</small></p>
          </div>`;
        cont.appendChild(col);
        bindCardClick(col.querySelector('.card-report'));
      }
      updateCount();
    }

    function switchPane(id) {
      document.querySelectorAll('.section-pane').forEach(p => p.classList.remove('active'));
      document.getElementById(id)?.classList.add('active');
      document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`.side-btn[data-target="${id}"]`)?.classList.add('active');
    }

    window.addEventListener('DOMContentLoaded', async () => {
      // 左側切換
      document.querySelectorAll('.side-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.target; switchPane(id);
        });
      });

      // 字數倒數
      const desc = $('#description'); const max = +(desc?.getAttribute('maxlength') || 50);
      desc?.addEventListener('input', () => $('#charCount').textContent = `剩餘 ${Math.max(0, max - desc.value.length)} 字`);
      $('#charCount').textContent = `剩餘 ${max} 字`;




      // 送出回報
      const form = $('#reportForm');
      const submitBtn = form?.querySelector('button[type=submit]');
      form?.addEventListener('submit', async e => {
        e.preventDefault();
        try {
          const adoptionId = state.currentId;
          if (!adoptionId) {
            alert('請先在左側「選擇我的寵物」');
            return;
          }

          // 鎖定按鈕
          const submitBtn = document.querySelector('#reportForm button[type=submit]');
          submitBtn.disabled = true; submitBtn.textContent = '送出中…';

          const file = document.getElementById('photo')?.files?.[0] || null;
          const payload = {
            reportDate: document.getElementById('reportDate')?.value || '',
            notes: (document.getElementById('description')?.value || '').trim(),
            status: document.querySelector('input[name="status"]:checked')?.value || 'SUBMITTED',
            imageUrl: await toDataURL(file)
          };

          await window.__reportapi.createReport(adoptionId, payload);
          alert('回報已送出！');

          // 切到紀錄頁、重載紀錄、重置表單與字數
          switchPane('pane-records');
          await renderRecords(adoptionId);
          document.getElementById('reportForm').reset();
          document.getElementById('charCount').textContent = '剩餘 50 字';
        } catch (err) {
          console.error(err);
          alert('送出失敗，請稍後再試');
        } finally {
          const submitBtn = document.querySelector('#reportForm button[type=submit]');
          submitBtn.disabled = false; submitBtn.textContent = '提交';
        }


      });

      await loadMyAdoptions();


    });
  </script>
</body>

</html>