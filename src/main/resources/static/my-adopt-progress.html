<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>我的送養刊登進度 - PetPick</title>
    <link rel="icon" href="/images/pet-icon.png" type="image/x-icon">

    <!-- Bootstrap 5.3.2 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome（保留一種載入方式即可） -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- 主樣式 -->
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .step-circle {
            width: 86px;
            height: 86px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f7ede0;
            color: #a87954;
            font-weight: 600;
            font-size: 32px;
            margin: 0 auto;
        }

        .step-active {
            background: #cfa178;
            color: #fff;
        }

        .step-text {
            margin-top: .5rem;
            color: #7a7066
        }

        /* 固定縮圖高度，但維持比例不裁切 */
        .thumb-box {
            width: 100%;
            height: 220px;
            /* 調整你要的縮圖高度 */
            background-color: #f8f9fa;
            border-radius: .5rem;
            overflow: hidden;
        }

        .bg-contain {
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            /* 關鍵：完整顯示，信箱灰邊 */
        }

        .thumb-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* 關鍵：不裁切、完整顯示 */
            display: block;
        }

        #tabs .btn.active {
            background: #cfa178;
            color: #fff;
            border-color: #cfa178;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/index.html">
                <img src="/images/pet-icon.png" width="36" height="36" class="d-inline-block align-top" alt="logo">
                PetPick
            </a>

            <!-- Bootstrap 5 屬性 -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center w-100">
                    <ul class="navbar-nav mb-2 mb-lg-0">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle btn btn-login m-1" href="#" id="adoptDropdown"
                                role="button" data-bs-toggle="dropdown" aria-expanded="false">尋找領養</a>
                            <ul class="dropdown-menu" aria-labelledby="adoptDropdown">
                                <li><a class="dropdown-item" href="/gov-list.html">公立認養</a></li>
                                <li><a class="dropdown-item" href="/adopt-list.html">領養認養</a></li>
                                <li><a class="dropdown-item" href="/post-adopt.html">刊登送養</a></li>
                                <li><a class="dropdown-item" href="/adopt-report.html">收養回報</a></li>
                            </ul>
                        </li>
                        <li class="nav-item"><a class="nav-link btn btn-login m-1"
                                href="/mission/missonMain.html">尋找任務</a></li>
                        <li class="nav-item"><a class="nav-link btn btn-login m-1" href="/shop/index.html">寵物商城</a></li>

                    </ul>

                    <!-- ✅ 這裡放登入/登出 & 管理員入口 -->
                    <div id="authArea" class="ms-auto d-flex gap-2 align-items-center"></div>

                    <!-- 手機版：選單最下面一排的三顆 -->
                    <div class="d-lg-none mt-2 mobile-iconbar">
                        <button class="btn btn-material" aria-label="聊天"><span
                                class="material-icons">chat_bubble_outline</span></button>
                        <button class="btn btn-material" aria-label="購物車"><span
                                class="material-icons">shopping_cart</span></button>
                        <button class="btn btn-material" aria-label="帳號" id="mobileAccountBtn"><span
                                class="material-icons">account_circle</span></button>
                    </div>

                    <!-- 桌機版：固定右上角三顆（與 index.html 同步隱藏） -->
                    <div id="desktop-iconbar" class="d-none d-lg-block position-fixed end-0 m-4" style="z-index:1030;">
                        <button class="btn btn-material" aria-label="聊天"><span
                                class="material-icons">chat_bubble_outline</span></button>
                        <button class="btn btn-material" aria-label="購物車"><span
                                class="material-icons">shopping_cart</span></button>
                        <button class="btn btn-material" aria-label="帳號" id="desktopAccountBtn"><span
                                class="material-icons">account_circle</span></button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="container pt-5 mt-4">
        <!-- 跨頁切換：我的刊登 / 我的申請 -->
        <div id="tabs-cross" class="btn-group mb-3">
            <a class="btn btn-outline-secondary" href="/my-adopt-progress.html?status=pending">我的刊登</a>
            <a class="btn btn-outline-secondary active" href="/my-apply.html?status=pending">我的申請</a>
        </div>
        <!-- Stepper -->
        <div class="row text-center mb-4">
            <div class="col">
                <div id="step1" class="step-circle">1</div>
                <div class="step-text">已送出</div>
            </div>
            <div class="col">
                <div id="step2" class="step-circle">2</div>
                <div class="step-text">審核中</div>
            </div>
            <div class="col">
                <div id="step3" class="step-circle">3</div>
                <div class="step-text">刊登成功</div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">我的送養刊登進度</h3>
            <div class="d-flex align-items-center gap-2" id="tabs">
                <a href="#" data-to="pending" class="btn btn-outline-secondary btn-sm">審核中</a>
                <a href="#" data-to="approved" class="btn btn-outline-secondary btn-sm">刊登完成</a>
            </div>
        </div>

        <div id="list" class="row g-3"></div> <!-- ← 少了這個 -->
        <p id="emptyHint" class="text-muted text-center my-5 d-none">
            目前沒有送養貼文，<a href="/post-adopt.html">點這裡去刊登</a>。
        </p>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="/js/authbar.js"></script>
    <script type="module">
        // 讀取查詢參數：status = pending / approved（預設 pending）
        const url = new URL(location.href);
        const status = url.searchParams.get('status') || 'pending';

        // Stepper：只亮當前步驟（pending→亮2；approved→亮3）
        const on = id => document.getElementById(id)?.classList.add('step-active');
        const off = id => document.getElementById(id)?.classList.remove('step-active');
        ['step1', 'step2', 'step3'].forEach(off);
        if (status === 'approved') on('step3');   // 只亮 3
        else on('step2');   // 只亮 2

        // 取得登入狀態，未登入就導去 login
        const auth = await fetch('/api/auth/status', { credentials: 'include' }).then(r => r.json());
        if (!auth.loggedIn) {
            sessionStorage.setItem('redirect', location.pathname + location.search);
            location.replace('/login.html');
            throw new Error('redirecting to login'); // ★ 加這行，中斷後續程式
        }

        // 管理員不該在此頁，直接導去審核中心
        if (auth.role === 'ADMIN') {
            location.replace('/post-review.html');
            throw new Error('redirecting: admin'); // ★ 加這行，中斷後續程式
        }

        // 依 status 打 API：/api/posts/my?status=...
        const api = `/api/posts/my?status=${encodeURIComponent(status)}`;

        let data = [];
        try {
            if (status === 'approved') {
                const [r1, r2] = await Promise.all([
                    fetch('/api/posts/my?status=approved', { credentials: 'include' }),
                    fetch('/api/posts/my?status=on_hold', { credentials: 'include' })
                ]);
                const a = r1.ok ? await r1.json() : [];
                const b = r2.ok ? await r2.json() : [];
                data = [...a, ...b].sort((x, y) => new Date(y.createdAt) - new Date(x.createdAt));
            } else {
                const res = await fetch(`/api/posts/my?status=${encodeURIComponent(status)}`, { credentials: 'include' });
                data = res.ok ? await res.json() : [];
            }
        } catch (err) {
            console.error(err);
        }


        // 產卡
        const list = document.getElementById('list');
        const empty = document.getElementById('emptyHint');

        const badge = s =>
            s === 'approved' ? '<span class="badge text-bg-success">刊登成功</span>' :
                s === 'on_hold' ? '<span class="badge text-bg-secondary">暫停中</span>' :
                    s === 'rejected' ? '<span class="badge text-bg-danger">退件</span>' :
                        '<span class="badge text-bg-warning text-dark">審核中</span>';

        const fallback = '/images/no-image.jpg';
        const firstImg = p => p.image1 || p.image2 || p.image3 || fallback;

        list.innerHTML = data.map(p => `
        <div class="col-12">
            <div class="card shadow-sm">
            <div class="row g-0">
                <div class="col-md-4">
                <div class="thumb-box bg-contain" style="background-image:url('${firstImg(p)}');"></div>
                </div>
                <div class="col-md-8">
                <div class="card-body">
                    <h5 class="card-title mb-2">${p.title || '未命名'} │ ${p.breed || p.species || ''}</h5>
                    <p class="mb-2">審核狀態：${badge(p.status)}</p>
                    <p class="text-muted mb-3">送出日期：${(p.createdAt ?? '').toString().substring(0, 10)}</p>

                    <div class="d-flex gap-2">
                    ${p.status === 'pending' ? `
                        <button class="btn btn-outline-danger btn-sm" onclick="cancelPost(${p.id})">取消刊登</button>
                    ` : ''}

                    ${p.status === 'approved' ? `
                        <button class="btn btn-outline-warning btn-sm" onclick="holdPost(${p.id}, true)">暫停</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="closePost(${p.id})">關閉</button>
                    ` : ''}

                    ${p.status === 'on_hold' ? `
                        <button class="btn btn-outline-success btn-sm" onclick="holdPost(${p.id}, false)">恢復</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="closePost(${p.id})">關閉</button>
                    ` : ''}
                    </div>
                </div>
                </div>
            </div>
            </div>
        </div>
        `).join('');


        if (!data.length) empty.classList.remove('d-none');

        // tabs 切換（右上角「審核中 / 刊登完成」）
        const tabs = document.getElementById('tabs');
        if (tabs) {
            tabs.querySelectorAll('a').forEach(a => {
                const to = a.dataset.to; // 'pending' 或 'approved'
                if (to === status) a.classList.add('active'); // 高亮目前頁籤
                a.addEventListener('click', e => {
                    e.preventDefault();
                    location.href = `/my-adopt-progress.html?status=${to}`;
                });
            });
        }

        window.cancelPost = async (id) => {
            if (!confirm('確定要取消這筆刊登嗎？')) return;
            const ok = await fetch(`/api/posts/${id}/cancel`, { method: 'PATCH', credentials: 'include' }).then(r => r.ok);
            alert(ok ? '已取消' : '取消失敗');
            if (ok) location.reload();
        };

        window.holdPost = async (id, hold = true) => {
            const msg = hold ? '暫停上架？' : '恢復上架？';
            if (!confirm(msg)) return;
            const ok = await fetch(`/api/posts/${id}/hold?hold=${hold}`, { method: 'PATCH', credentials: 'include' }).then(r => r.ok);
            alert(ok ? '已更新' : '更新失敗');
            if (ok) location.reload();
        };

        window.closePost = async (id) => {
            if (!confirm('確定要關閉（代表已送養完成）？')) return;
            const ok = await fetch(`/api/posts/${id}/close`, { method: 'PATCH', credentials: 'include' }).then(r => r.ok);
            alert(ok ? '已關閉' : '關閉失敗');
            if (ok) location.reload();
        };
    </script>

</body>

</html>